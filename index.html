<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suno ìŒì› â†’ ì•…ë³´ ë³€í™˜ê¸°</title>
    <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.3/build/cjs/vexflow.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pitchfinder@2.3.0/dist/pitchfinder.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; padding: 40px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        h1 { text-align: center; color: #667eea; margin-bottom: 10px; font-size: 2.5em; }
        .subtitle { text-align: center; color: #666; margin-bottom: 40px; font-size: 1.1em; }
        .upload-area { border: 3px dashed #667eea; border-radius: 15px; padding: 60px 20px; text-align: center; background: #f8f9ff; cursor: pointer; margin-bottom: 30px; }
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px 40px; border-radius: 30px; font-size: 1.1em; cursor: pointer; margin: 10px; transition: transform 0.2s; }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .controls { text-align: center; margin: 30px 0; }
        .status { text-align: center; padding: 20px; background: #f0f1ff; border-radius: 10px; margin: 20px 0; display: none; }
        .status.show { display: block; }
        .progress-bar { width: 100%; height: 8px; background: #e0e0e0; border-radius: 10px; overflow: hidden; margin: 20px 0; display: none; }
        .progress-bar.show { display: block; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); width: 0%; transition: width 0.3s; }
        #sheetMusic { margin-top: 40px; padding: 30px; background: #fff; border-radius: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); display: none; overflow-x: auto; }
        #sheetMusic.show { display: block; }
        .settings { background: #f8f9ff; padding: 20px; border-radius: 10px; margin: 20px 0; }
        .settings label { display: block; margin: 15px 0 5px; font-weight: 600; color: #333; }
        .settings input[type="text"], .settings select, .settings input[type="range"] { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd; }
        .range-value { display: inline-block; margin-left: 10px; color: #667eea; font-weight: 600; }
        .info-box { background: #fff3cd; border: 1px solid #ffc107; padding: 15px; border-radius: 8px; margin: 20px 0; color: #856404; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸµ ìŒì› â†’ ì•…ë³´ ë³€í™˜ê¸°</h1>
        <p class="subtitle">Sunoì—ì„œ ë§Œë“  ìŒì›ì„ ì—…ë¡œë“œí•˜ì—¬ ì•…ë³´ë¡œ ë³€í™˜í•˜ì„¸ìš”</p>
        
        <div class="info-box">
            <h3>ğŸ’¡ ì‚¬ìš© íŒ</h3>
            <ul>
                <li>ë‹¨ìˆœí•œ ë©œë¡œë””ì¼ìˆ˜ë¡ ì •í™•ë„ê°€ ë†’ìŠµë‹ˆë‹¤.</li>
                <li><strong>ì‰¬ì›€</strong> ë‚œì´ë„ëŠ” ë©œë¡œë””ì˜ ë¼ˆëŒ€ë§Œ, <strong>ì–´ë ¤ì›€</strong>ì€ ì„¸ë°€í•œ ê¸°êµê¹Œì§€ ì¡ì•„ëƒ…ë‹ˆë‹¤.</li>
            </ul>
        </div>
        
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ğŸ“</div>
            <h2>ìŒì› íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ë“œë˜ê·¸í•˜ì„¸ìš”</h2>
            <input type="file" id="audioFile" accept="audio/*" style="display:none;">
        </div>
        
        <div class="settings">
            <h3 style="margin-bottom: 15px;">ğŸ“ ì•…ë³´ ì •ë³´ ì…ë ¥</h3>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <div style="flex: 1;">
                    <label>ê³¡ ì œëª©</label>
                    <input type="text" id="sheetTitle" placeholder="ì˜ˆ: My Suno Song">
                </div>
                <div style="flex: 1;">
                    <label>ì•„í‹°ìŠ¤íŠ¸ / ì‘ê³¡ê°€</label>
                    <input type="text" id="sheetArtist" placeholder="ì˜ˆ: Suno AI">
                </div>
            </div>

            <h3 style="margin-bottom: 15px;">âš™ï¸ ë³€í™˜ ì„¤ì •</h3>
            <label>ë¶„ì„ ë¯¼ê°ë„</label>
            <input type="range" id="sensitivity" min="0.3" max="0.9" step="0.1" value="0.6">
            <span class="range-value" id="sensitivityValue">0.6</span>
            
            <label>ë°•ì</label>
            <select id="timeSignature">
                <option value="4/4" selected>4/4ë°•ì</option>
                <option value="3/4">3/4ë°•ì</option>
                <option value="6/8">6/8ë°•ì</option>
            </select>

            <label>ì•…ë³´ ë‚œì´ë„</label>
            <select id="difficulty">
                <option value="easy">ì‰¬ì›€ (ì‹¬í”Œí•œ ë©œë¡œë””)</option>
                <option value="normal" selected>ë³´í†µ (ê¸°ë³¸ ë©œë¡œë””)</option>
                <option value="hard">ì–´ë ¤ì›€ (ì •ë°€í•œ ë¶„ì„)</option>
            </select>
        </div>
        
        <div class="controls">
            <button class="btn" id="convertBtn" disabled>ğŸ¼ ì•…ë³´ë¡œ ë³€í™˜</button>
        </div>
        
        <div class="progress-bar" id="progressBar"><div class="progress-fill" id="progressFill"></div></div>
        <div class="status" id="status"></div>
        <div id="sheetMusic"></div>
    </div>

    <script>
        const VF = Vex.Flow;
        let audioBuffer = null;
        let pianoNotes = [];
        let synth = null;

        const controls = document.querySelector('.controls');
        const uploadArea = document.getElementById('uploadArea');
        const audioFileInput = document.getElementById('audioFile');
        const convertBtn = document.getElementById('convertBtn');
        const statusDiv = document.getElementById('status');
        const sheetMusicDiv = document.getElementById('sheetMusic');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');

        // ë²„íŠ¼ ìƒì„±
        const playBtn = document.createElement('button');
        playBtn.className = 'btn'; playBtn.innerHTML = 'â–¶ï¸ ì „ì²´ ì•…ë³´ ë“¤ì–´ë³´ê¸°'; playBtn.style.display = 'none';
        playBtn.style.background = 'linear-gradient(135deg, #11998e 0%, #38ef7d 100%)';

        const pdfBtn = document.createElement('button');
        pdfBtn.className = 'btn'; pdfBtn.innerHTML = 'ğŸ“„ PDFë¡œ ì €ì¥'; pdfBtn.style.display = 'none';
        pdfBtn.style.background = 'linear-gradient(135deg, #FF512F 0%, #DD2476 100%)';

        controls.appendChild(playBtn);
        controls.appendChild(pdfBtn);

        uploadArea.addEventListener('click', () => audioFileInput.click());
        audioFileInput.addEventListener('change', e => { if(e.target.files[0]) handleFile(e.target.files[0]); });

        async function handleFile(file) {
            showStatus(`ğŸ“‚ ${file.name} ë¡œë”© ì¤‘...`);
            try {
                const arrayBuffer = await file.arrayBuffer();
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                showStatus(`âœ… ë¡œë”© ì™„ë£Œ! (${audioBuffer.duration.toFixed(1)}ì´ˆ)`);
                convertBtn.disabled = false;
            } catch (e) { showStatus("âŒ íŒŒì¼ ì½ê¸° ì‹¤íŒ¨", true); }
        }

        convertBtn.addEventListener('click', convertToFullSheet);

        async function convertToFullSheet() {
            if (!audioBuffer) return;
            convertBtn.disabled = true;
            playBtn.style.display = 'none';
            pdfBtn.style.display = 'none';
            progressBar.classList.add('show');
            showStatus("ğŸµ ìŒì› ë¶„ì„ ì¤‘...");

            const channelData = audioBuffer.getChannelData(0);
            const sampleRate = audioBuffer.sampleRate;
            const detector = Pitchfinder.YIN({ sampleRate });
            const hopSize = 2048;
            const detected = [];

            const sensitivity = parseFloat(document.getElementById('sensitivity').value);
            const rmsThreshold = (1 - sensitivity) * 0.2; 

            for (let i = 0; i < channelData.length; i += hopSize) {
                const segment = channelData.slice(i, i + hopSize);
                const freq = detector(segment);
                const rms = Math.sqrt(segment.reduce((s, v) => s + v*v, 0) / segment.length);
                if (freq && rms > rmsThreshold) detected.push({ freq, time: i / sampleRate });
                if (i % (hopSize * 100) === 0) updateProgress((i / channelData.length) * 100);
            }

            pianoNotes = processMelody(detected);
            renderMultiLineSheet(pianoNotes);
            updateProgress(100);
            showStatus(`âœ… ë³€í™˜ ì™„ë£Œ! ì´ ${pianoNotes.length}ê°œì˜ ìŒí‘œ ì¶”ì¶œ.`);
            convertBtn.disabled = false;
        }

        function processMelody(data) {
            const processed = [];
            let lastTime = -1;
            const difficulty = document.getElementById('difficulty').value;
            
            let minGap;
            switch(difficulty) {
                case 'easy':   minGap = 0.6; break;
                case 'normal': minGap = 0.35; break;
                case 'hard':   minGap = 0.15; break;
                default: minGap = 0.35;
            }
            
            data.forEach(d => {
                if (d.time - lastTime > minGap) {
                    const note = frequencyToNote(d.freq);
                    if (note.octave >= 3 && note.octave <= 6) {
                        processed.push({ note, time: d.time });
                        lastTime = d.time;
                    }
                }
            });
            return processed;
        }

        function frequencyToNote(freq) {
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const halfSteps = Math.round(12 * Math.log2(freq / 440) + 69);
            const name = noteNames[halfSteps % 12];
            const octave = Math.floor(halfSteps / 12) - 1;
            return { name, octave, full: `${name}/${octave}` };
        }

        function renderMultiLineSheet(notes) {
            sheetMusicDiv.innerHTML = '';
            sheetMusicDiv.classList.add('show');
            if (notes.length === 0) { showStatus("âŒ ê°ì§€ëœ ë©œë¡œë””ê°€ ì—†ìŠµë‹ˆë‹¤.", true); return; }

            const title = document.getElementById('sheetTitle').value || "Untitled";
            const artist = document.getElementById('sheetArtist').value || "Suno AI";
            const timeSig = document.getElementById('timeSignature').value;

            const notesPerMeasure = 4;
            const measuresPerRow = 2;
            const totalMeasures = Math.ceil(notes.length / notesPerMeasure);
            const totalRows = Math.ceil(totalMeasures / measuresPerRow);

            const renderer = new VF.Renderer(sheetMusicDiv, VF.Renderer.Backends.SVG);
            const width = 800;
            const headerHeight = 100;
            const height = (totalRows * 150) + headerHeight + 50;
            renderer.resize(width, height);
            const context = renderer.getContext();

            context.setFont("Arial", 22, "bold").fillText(title, width / 2 - (title.length * 5), 40);
            context.setFont("Arial", 12, "normal").fillText("Artist: " + artist, width - 150, 70);

            for (let m = 0; m < totalMeasures; m++) {
                const row = Math.floor(m / measuresPerRow);
                const col = m % measuresPerRow;
                const x = col * (width / measuresPerRow) + 10;
                const y = (row * 150) + headerHeight;

                const stave = new VF.Stave(x, y, (width / measuresPerRow) - 20);
                if (m === 0) stave.addClef('treble').addTimeSignature(timeSig);
                else if (col === 0) stave.addClef('treble');
                stave.setContext(context).draw();

                const measureNotesData = notes.slice(m * notesPerMeasure, (m + 1) * notesPerMeasure);
                if (measureNotesData.length > 0) {
                    const vfNotes = measureNotesData.map(n => {
                        const sn = new VF.StaveNote({ keys: [n.note.full], duration: "q" });
                        if (n.note.name.includes('#')) sn.addModifier(new VF.Accidental('#'), 0);
                        return sn;
                    });
                    const voice = new VF.Voice({ num_beats: measureNotesData.length, beat_value: 4 }).setStrict(false);
                    voice.addTickables(vfNotes);
                    new VF.Formatter().joinVoices([voice]).format([voice], (width / measuresPerRow) - 80);
                    voice.draw(context, stave);
                }
            }
            playBtn.style.display = 'inline-block';
            pdfBtn.style.display = 'inline-block';
        }

        playBtn.addEventListener('click', async () => {
            await Tone.start();
            if (!synth) synth = new Tone.PolySynth(Tone.Synth).toDestination();
            const now = Tone.now();
            const difficulty = document.getElementById('difficulty').value;
            const playGap = difficulty === 'hard' ? 0.3 : 0.5; // ë‚œì´ë„ë³„ ì¬ìƒ ì†ë„ ì²´ê° ì¡°ì ˆ
            
            pianoNotes.forEach((n, i) => {
                synth.triggerAttackRelease(n.note.full.replace('/', ''), "8n", now + (i * playGap));
            });
            showStatus("ğŸ¹ í”¼ì•„ë…¸ ì¬ìƒ ì¤‘...");
        });

        pdfBtn.addEventListener('click', async () => {
            const { jsPDF } = window.jspdf;
            showStatus("ğŸ“„ PDF ìƒì„± ì¤‘...");
            try {
                const canvas = await html2canvas(sheetMusicDiv, { scale: 2, backgroundColor: "#ffffff" });
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jsPDF('p', 'mm', 'a4');
                const imgWidth = 210;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                let position = 0;

                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= 297;
                while (heightLeft > 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= 297;
                }
                pdf.save(`${document.getElementById('sheetTitle').value || 'Sheet'}.pdf`);
                showStatus("âœ… PDF ì €ì¥ ì™„ë£Œ!");
            } catch (e) { showStatus("âŒ PDF ì €ì¥ ì‹¤íŒ¨", true); }
        });

        function showStatus(msg, err) { statusDiv.textContent = msg; statusDiv.style.background = err ? "#ffebee" : "#f0f1ff"; statusDiv.classList.add('show'); }
        function updateProgress(p) { progressFill.style.width = p + '%'; }
        document.getElementById('sensitivity').addEventListener('input', e => document.getElementById('sensitivityValue').textContent = e.target.value);
    </script>
</body>
</html>
