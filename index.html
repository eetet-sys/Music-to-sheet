<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suno ìŒì› â†’ ì•…ë³´ ë³€í™˜ê¸°</title>
    <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vexflow@4.2.3/build/cjs/vexflow.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pitchfinder@2.3.0/dist/pitchfinder.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 10px;
            font-size: 2.5em;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 40px;
            font-size: 1.1em;
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 30px;
        }
        
        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f1ff;
        }
        
        .upload-area.dragover {
            background: #e8eaff;
            border-color: #764ba2;
        }
        
        .upload-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }
        
        input[type="file"] {
            display: none;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 1.1em;
            cursor: pointer;
            transition: transform 0.2s;
            margin: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .controls {
            text-align: center;
            margin: 30px 0;
        }
        
        .status {
            text-align: center;
            padding: 20px;
            background: #f0f1ff;
            border-radius: 10px;
            margin: 20px 0;
            display: none;
        }
        
        .status.show {
            display: block;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }
        
        .progress-bar.show {
            display: block;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
        }
        
        #sheetMusic {
            margin-top: 40px;
            padding: 30px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow-x: auto;
            display: none;
        }
        
        #sheetMusic.show {
            display: block;
        }
        
        .settings {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .settings label {
            display: block;
            margin: 15px 0 5px;
            font-weight: 600;
            color: #333;
        }
        
        .settings select, .settings input[type="range"] {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .range-value {
            display: inline-block;
            margin-left: 10px;
            color: #667eea;
            font-weight: 600;
        }
        
        .info-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .info-box h3 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .info-box ul {
            margin-left: 20px;
            color: #856404;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸµ ìŒì› â†’ ì•…ë³´ ë³€í™˜ê¸°</h1>
        <p class="subtitle">Sunoì—ì„œ ë§Œë“  ìŒì›ì„ ì—…ë¡œë“œí•˜ì—¬ ì•…ë³´ë¡œ ë³€í™˜í•˜ì„¸ìš”</p>
        
        <div class="info-box">
            <h3>ğŸ’¡ ì‚¬ìš© íŒ</h3>
            <ul>
                <li>ë‹¨ìˆœí•œ ë©œë¡œë””ì¼ìˆ˜ë¡ ì •í™•ë„ê°€ ë†’ìŠµë‹ˆë‹¤</li>
                <li>ë³´ì»¬ë§Œ ìˆê±°ë‚˜ ì•…ê¸°ê°€ ì ì€ ìŒì›ì´ ì¢‹ìŠµë‹ˆë‹¤</li>
                <li>ë„ˆë¬´ ê¸´ ìŒì›(3ë¶„ ì´ìƒ)ì€ ì²˜ë¦¬ ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤</li>
            </ul>
        </div>
        
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ğŸ“</div>
            <h2>ìŒì› íŒŒì¼ì„ ì„ íƒí•˜ê±°ë‚˜ ë“œë˜ê·¸í•˜ì„¸ìš”</h2>
            <p style="margin-top: 10px; color: #666;">ì§€ì› í˜•ì‹: MP3, WAV, OGG, M4A</p>
            <input type="file" id="audioFile" accept="audio/*">
        </div>
        
        <div class="settings">
            <h3 style="margin-bottom: 15px;">âš™ï¸ ë³€í™˜ ì„¤ì •</h3>
            
            <label>ë¶„ì„ ë¯¼ê°ë„</label>
            <input type="range" id="sensitivity" min="0.3" max="0.9" step="0.1" value="0.6">
            <span class="range-value" id="sensitivityValue">0.6</span>
            
            <label>ìŒí‘œ ê¸¸ì´ ë‹¨ìœ„</label>
            <select id="noteUnit">
                <option value="16">16ë¶„ìŒí‘œ</option>
                <option value="8" selected>8ë¶„ìŒí‘œ</option>
                <option value="4">4ë¶„ìŒí‘œ</option>
            </select>
            
            <label>ë°•ì</label>
            <select id="timeSignature">
                <option value="4/4" selected>4/4ë°•ì</option>
                <option value="3/4">3/4ë°•ì</option>
                <option value="6/8">6/8ë°•ì</option>
            </select>
        </div>
        
        <div class="controls">
            <button class="btn" id="convertBtn" disabled>ğŸ¼ ì•…ë³´ë¡œ ë³€í™˜</button>
            <button class="btn" id="downloadBtn" style="display: none;">ğŸ’¾ ì•…ë³´ ë‹¤ìš´ë¡œë“œ (PNG)</button>
        </div>
        
        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        
        <div class="status" id="status"></div>
        
        <div id="sheetMusic"></div>
    </div>

    <script>
        const VF = Vex.Flow;
        let audioBuffer = null;
        let currentFile = null;
        
        // UI ìš”ì†Œ
        const uploadArea = document.getElementById('uploadArea');
        const audioFileInput = document.getElementById('audioFile');
        const convertBtn = document.getElementById('convertBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const statusDiv = document.getElementById('status');
        const sheetMusicDiv = document.getElementById('sheetMusic');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        
        // ì„¤ì •
        const sensitivityInput = document.getElementById('sensitivity');
        const sensitivityValue = document.getElementById('sensitivityValue');
        const noteUnitSelect = document.getElementById('noteUnit');
        const timeSignatureSelect = document.getElementById('timeSignature');
        
        sensitivityInput.addEventListener('input', (e) => {
            sensitivityValue.textContent = e.target.value;
        });
        
        // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
        uploadArea.addEventListener('click', () => audioFileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('audio/')) {
                handleFile(file);
            }
        });
        
        audioFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                handleFile(file);
            }
        });
        
        async function handleFile(file) {
            currentFile = file;
            showStatus(`ğŸ“‚ ${file.name} ë¡œë”© ì¤‘...`);
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
                
                showStatus(`âœ… íŒŒì¼ ë¡œë”© ì™„ë£Œ! (${audioBuffer.duration.toFixed(1)}ì´ˆ)`);
                convertBtn.disabled = false;
            } catch (error) {
                showStatus(`âŒ ì˜¤ë¥˜: ${error.message}`, true);
            }
        }
        
        convertBtn.addEventListener('click', convertToSheet);
        
        async function convertToSheet() {
            if (!audioBuffer) return;
            
            convertBtn.disabled = true;
            sheetMusicDiv.classList.remove('show');
            downloadBtn.style.display = 'none';
            progressBar.classList.add('show');
            
            showStatus('ğŸµ ìŒì› ë¶„ì„ ì¤‘...');
            updateProgress(10);
            
            try {
                // ì˜¤ë””ì˜¤ ë°ì´í„° ì¶”ì¶œ
                const channelData = audioBuffer.getChannelData(0);
                const sampleRate = audioBuffer.sampleRate;
                
                updateProgress(30);
                showStatus('ğŸ¼ ìŒë†’ì´ ê°ì§€ ì¤‘...');
                
                // í”¼ì¹˜ ê²€ì¶œ
                const notes = await detectPitches(channelData, sampleRate);
                
                updateProgress(60);
                showStatus('ğŸ“ ì•…ë³´ ìƒì„± ì¤‘...');
                
                // ì•…ë³´ ë Œë”ë§
                renderSheet(notes);
                
                updateProgress(100);
                showStatus('âœ… ë³€í™˜ ì™„ë£Œ!');
                
                sheetMusicDiv.classList.add('show');
                downloadBtn.style.display = 'inline-block';
                
                setTimeout(() => {
                    progressBar.classList.remove('show');
                }, 1000);
                
            } catch (error) {
                showStatus(`âŒ ë³€í™˜ ì˜¤ë¥˜: ${error.message}`, true);
                console.error(error);
            } finally {
                convertBtn.disabled = false;
            }
        }
        
        async function detectPitches(channelData, sampleRate) {
            const sensitivity = parseFloat(sensitivityInput.value);
            const hopSize = 512;
            const notes = [];
            
            // ê°„ë‹¨í•œ zero-crossing ê¸°ë°˜ í”¼ì¹˜ ê²€ì¶œ
            for (let i = 0; i < channelData.length - hopSize; i += hopSize) {
                const segment = channelData.slice(i, i + hopSize);
                
                // RMS (ì—ë„ˆì§€) ê³„ì‚°
                const rms = Math.sqrt(segment.reduce((sum, val) => sum + val * val, 0) / segment.length);
                
                if (rms > 0.01) { // ìµœì†Œ ìŒëŸ‰ ì„ê³„ê°’
                    // Zero-crossing rateë¡œ ëŒ€ëµì ì¸ ì£¼íŒŒìˆ˜ ì¶”ì •
                    let crossings = 0;
                    for (let j = 1; j < segment.length; j++) {
                        if ((segment[j-1] >= 0 && segment[j] < 0) || (segment[j-1] < 0 && segment[j] >= 0)) {
                            crossings++;
                        }
                    }
                    
                    const freq = (crossings / 2) * (sampleRate / hopSize);
                    
                    if (freq > 80 && freq < 1000) { // ìœ íš¨í•œ ì£¼íŒŒìˆ˜ ë²”ìœ„
                        const note = frequencyToNote(freq);
                        const time = i / sampleRate;
                        notes.push({ note, time, frequency: freq, energy: rms });
                    }
                }
            }
            
            // ë¹„ìŠ·í•œ ì‹œê°„ì˜ ë…¸íŠ¸ë“¤ì„ ë³‘í•©
            return mergeNotes(notes);
        }
        
        function frequencyToNote(freq) {
            const A4 = 440;
            const C0 = A4 * Math.pow(2, -4.75);
            const halfSteps = Math.round(12 * Math.log2(freq / C0));
            const octave = Math.floor(halfSteps / 12);
            const noteIndex = halfSteps % 12;
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            
            return {
                name: noteNames[noteIndex],
                octave: octave,
                full: noteNames[noteIndex] + '/' + octave
            };
        }
        
        function mergeNotes(notes) {
            if (notes.length === 0) return [];
            
            const noteUnit = parseInt(noteUnitSelect.value);
            const minDuration = 0.1; // ìµœì†Œ ìŒí‘œ ê¸¸ì´ (ì´ˆ)
            
            const merged = [];
            let current = notes[0];
            let startTime = current.time;
            
            for (let i = 1; i < notes.length; i++) {
                const timeDiff = notes[i].time - current.time;
                
                if (timeDiff > minDuration || notes[i].note.name !== current.note.name) {
                    merged.push({
                        ...current,
                        duration: timeDiff,
                        startTime: startTime
                    });
                    current = notes[i];
                    startTime = notes[i].time;
                }
            }
            
            // ë§ˆì§€ë§‰ ë…¸íŠ¸ ì¶”ê°€
            if (current) {
                merged.push({
                    ...current,
                    duration: 0.5,
                    startTime: startTime
                });
            }
            
            return merged.slice(0, 32); // ìµœëŒ€ 32ê°œ ìŒí‘œ
        }
        
        function renderSheet(notes) {
            sheetMusicDiv.innerHTML = '';
            
            if (notes.length === 0) {
                sheetMusicDiv.innerHTML = '<p style="text-align: center; color: #999;">ê²€ì¶œëœ ìŒí‘œê°€ ì—†ìŠµë‹ˆë‹¤. ë¯¼ê°ë„ë¥¼ ì¡°ì ˆí•´ë³´ì„¸ìš”.</p>';
                sheetMusicDiv.classList.add('show');
                return;
            }
            
            const width = Math.max(800, notes.length * 50 + 200);
            const renderer = new VF.Renderer(sheetMusicDiv, VF.Renderer.Backends.SVG);
            renderer.resize(width, 250);
            const context = renderer.getContext();
            
            const stave = new VF.Stave(10, 40, width - 20);
            stave.addClef('treble');
            
            const timeSignature = timeSignatureSelect.value;
            stave.addTimeSignature(timeSignature);
            
            stave.setContext(context).draw();
            
            // VexFlow ë…¸íŠ¸ë¡œ ë³€í™˜
            const vfNotes = notes.map(noteData => {
                const noteName = noteData.note.name.replace('#', '#');
                const octave = noteData.note.octave;
                
                // ìŒí‘œ ê¸¸ì´ ê²°ì • (ê°„ë‹¨í•˜ê²Œ 8ë¶„ìŒí‘œë¡œ í†µì¼)
                const duration = 'q'; // quarter note
                
                let keys = [`${noteName}/${octave}`];
                
                const staveNote = new VF.StaveNote({
                    keys: keys,
                    duration: duration,
                    clef: 'treble'
                });
                
                // ìƒ¾ì´ ìˆìœ¼ë©´ ì¶”ê°€
                if (noteName.includes('#')) {
                    staveNote.addModifier(new VF.Accidental('#'), 0);
                }
                
                return staveNote;
            });
            
            // ë³´ì´ìŠ¤ ìƒì„± ë° ë Œë”ë§
            try {
                const voice = new VF.Voice({
                    num_beats: notes.length,
                    beat_value: 4
                });
                voice.addTickables(vfNotes);
                
                const formatter = new VF.Formatter();
                formatter.joinVoices([voice]).format([voice], width - 100);
                
                voice.draw(context, stave);
            } catch (error) {
                console.error('ì•…ë³´ ë Œë”ë§ ì˜¤ë¥˜:', error);
            }
        }
        
        downloadBtn.addEventListener('click', () => {
            const svg = sheetMusicDiv.querySelector('svg');
            if (!svg) return;
            
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const svgData = new XMLSerializer().serializeToString(svg);
            const img = new Image();
            
            img.onload = () => {
                canvas.width = img.width;
                canvas.height = img.height;
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
                
                canvas.toBlob((blob) => {
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'sheet-music.png';
                    a.click();
                    URL.revokeObjectURL(url);
                });
            };
            
            img.src = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgData)));
        });
        
        function showStatus(message, isError = false) {
            statusDiv.textContent = message;
            statusDiv.style.background = isError ? '#ffebee' : '#f0f1ff';
            statusDiv.style.color = isError ? '#c62828' : '#333';
            statusDiv.classList.add('show');
        }
        
        function updateProgress(percent) {
            progressFill.style.width = percent + '%';
        }
    </script>
</body>
</html>
